"use strict";
var core_1 = require("@angular/core");
var dialog = require("ui/dialogs");
var nativescript_ably_1 = require("nativescript-ably");
var common_1 = require("nativescript-ably/api/common");
var Observable_1 = require("rxjs/Observable");
var Subject_1 = require("rxjs/Subject");
require("rxjs/add/observable/empty");
var MessageComponent = (function () {
    function MessageComponent(ngZone) {
        this.ngZone = ngZone;
        this.key = "hLux7A.hDMrDw:SxHnY-ynxRMzcDWP";
        this.channelId = "persistent:chat";
        this.messagesReceived = new Subject_1.Subject();
        this.message = "";
        this.status = new Subject_1.Subject();
        this.icon = "";
        this.history = [];
    }
    MessageComponent.prototype.ngOnInit = function () {
        this.icon = String.fromCharCode(0xe963);
        this.connect();
    };
    MessageComponent.prototype.ngOnDestroy = function () {
        this.channelSubscription.unsubscribe();
    };
    MessageComponent.prototype.connect = function () {
        var _this = this;
        if (this.ably == null) {
            console.info("Creating a new connection");
            this.ably = new nativescript_ably_1.AblyRealtime(this.key);
        }
        this.channelSubscription = this.subscribe();
        this.ably.connection.on()
            .subscribe(function (c) { return _this.ngZone.run(function () { return _this.onConnectionChange(c); }); }, this.handleError);
    };
    MessageComponent.prototype.sendMessage = function () {
        var message = this.message.trim() == "" ? "Default" : this.message;
        if (this.ably) {
            var object = JSON.stringify({ msg: message, from: "Code" });
            this.ably.channels.get(this.channelId)
                .publishData("chat", object)
                .catch(this.handleError)
                .subscribe();
        }
        else
            dialog.alert("You need to connect first");
    };
    MessageComponent.prototype.onMessage = function (message) {
        var json = message;
        this.messagesReceived.next(json.from + ": " + json.msg);
    };
    MessageComponent.prototype.onConnectionChange = function (change) {
        this.status.next(change.current);
        console.info("Connection Change State");
        if (change.current == "connecting") {
            console.info("We are connecting to the server");
        }
        try {
            console.log(change.current);
            console.log(change.reason);
        }
        catch (ex) {
            console.error(ex);
        }
    };
    MessageComponent.prototype.disconnect = function () {
        this.status.next("Disconnecting");
        if (this.ably) {
            console.info(this.ably.connection.key);
            this.ably.connection.close();
            this.ably = null;
        }
    };
    MessageComponent.prototype.unsubscribe = function () {
        if (this.channelSubscription) {
            this.channelSubscription.unsubscribe();
        }
    };
    MessageComponent.prototype.subscribe = function () {
        var _this = this;
        if (this.ably) {
            var channel = this.ably.channels.get(this.channelId);
            return channel.subscribe()
                .map(function (m) { return m.data; })
                .map(function (m) { return JSON.parse(m); })
                .do(function (m) { return console.log(m); })
                .catch(this.handleError) // If the connection throws any error
                .subscribe(function (m) { return _this.ngZone.run(function () { return _this.onMessage(m); }); });
        }
        else {
            return null;
        }
    };
    MessageComponent.prototype.getHistory = function () {
        var _this = this;
        console.info("Getting history");
        try {
            var param = new common_1.Param("untilAttach", "true");
            var params_1 = [param];
            this.ngZone.runOutsideAngular(function () {
                if (_this.ably) {
                    _this.ably.channels.get(_this.channelId).history(params_1).then(function (_) {
                        _this.history = _;
                        dialog.alert(JSON.stringify(_));
                    }).catch(function (_) { return dialog.alert(_); });
                }
            });
        }
        catch (e) {
            console.error(e);
        }
    };
    MessageComponent.prototype.handleError = function (e) {
        console.error("A error has catch by observer: ");
        console.error(e);
        dialog.alert(e.message);
        return Observable_1.Observable.empty();
    };
    MessageComponent = __decorate([
        core_1.Component({
            moduleId: module.id,
            selector: "my-message",
            templateUrl: "./message.component.html",
        }), 
        __metadata('design:paramtypes', [core_1.NgZone])
    ], MessageComponent);
    return MessageComponent;
}());
exports.MessageComponent = MessageComponent;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVzc2FnZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJtZXNzYWdlLmNvbXBvbmVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEscUJBQXFELGVBQWUsQ0FBQyxDQUFBO0FBQ3JFLElBQVksTUFBTSxXQUFNLFlBQVksQ0FBQyxDQUFBO0FBQ3JDLGtDQUFvRCxtQkFBbUIsQ0FBQyxDQUFBO0FBQ3hFLHVCQUFvQiw4QkFDcEIsQ0FBQyxDQURpRDtBQUNsRCwyQkFBMkIsaUJBQWlCLENBQUMsQ0FBQTtBQUU3Qyx3QkFBd0IsY0FDeEIsQ0FBQyxDQURxQztBQUN0QyxRQUFPLDJCQUEyQixDQUFDLENBQUE7QUFRbkM7SUFVSSwwQkFBb0IsTUFBYztRQUFkLFdBQU0sR0FBTixNQUFNLENBQVE7UUFSbEMsUUFBRyxHQUFHLGdDQUFnQyxDQUFBO1FBQ3RDLGNBQVMsR0FBRyxpQkFBaUIsQ0FBQTtRQUM3QixxQkFBZ0IsR0FBRyxJQUFJLGlCQUFPLEVBQVUsQ0FBQTtRQUN4QyxZQUFPLEdBQUcsRUFBRSxDQUFBO1FBQ1osV0FBTSxHQUFHLElBQUksaUJBQU8sRUFBVSxDQUFBO1FBRTlCLFNBQUksR0FBRyxFQUFFLENBQUE7UUFDVCxZQUFPLEdBQUcsRUFBRSxDQUFBO0lBR1osQ0FBQztJQUNELG1DQUFRLEdBQVI7UUFDSSxJQUFJLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxZQUFZLENBQUMsTUFBTSxDQUFDLENBQUE7UUFDdkMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFBO0lBQ2xCLENBQUM7SUFDRCxzQ0FBVyxHQUFYO1FBQ0ksSUFBSSxDQUFDLG1CQUFtQixDQUFDLFdBQVcsRUFBRSxDQUFBO0lBQzFDLENBQUM7SUFDTSxrQ0FBTyxHQUFkO1FBQUEsaUJBV0M7UUFWRyxFQUFFLENBQUMsQ0FBQyxJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxDQUFDLENBQUM7WUFDcEIsT0FBTyxDQUFDLElBQUksQ0FBQywyQkFB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QVMsQ0FBQztZQUNQLFFBQVEsRUFBRSxNQUFNLENBQUMsRUFBRTtZQUNuQixRQUFRLEVBQUUsWUFBWTtZQUN0QixXQUFXLEVBQUUsMEJBQTBCO1NBQzFDLENBQUM7O3dCQUFBO0lBNkhGLHVCQUFDO0FBQUQsQ0FBQyxBQTVIRCxJQTRIQztBQTVIWSx3QkFBZ0IsbUJBNEg1QixDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQ29tcG9uZW50LCBOZ1pvbmUsIE9uSW5pdCwgT25EZXN0cm95IH0gZnJvbSBcIkBhbmd1bGFyL2NvcmVcIjtcbmltcG9ydCAqIGFzIGRpYWxvZyBmcm9tIFwidWkvZGlhbG9nc1wiO1xuaW1wb3J0IHsgQWJseVJlYWx0aW1lLCBDb25uZWN0aW9uU3RhdGVDaGFuZ2UgfSBmcm9tIFwibmF0aXZlc2NyaXB0LWFibHlcIjtcbmltcG9ydCB7UGFyYW19IGZyb20gXCJuYXRpdmVzY3JpcHQtYWJseS9hcGkvY29tbW9uXCJcbmltcG9ydCB7IE9ic2VydmFibGUgfSBmcm9tIFwicnhqcy9PYnNlcnZhYmxlXCI7XG5pbXBvcnQgeyBTdWJzY3JpcHRpb24gfSBmcm9tIFwicnhqcy9TdWJzY3JpcHRpb25cIjtcbmltcG9ydCB7IFN1YmplY3QgfSBmcm9tIFwicnhqcy9TdWJqZWN0XCJcbmltcG9ydCBcInJ4anMvYWRkL29ic2VydmFibGUvZW1wdHlcIjtcblxuZGVjbGFyZSB2YXIgamF2YTogYW55O1xuQENvbXBvbmVudCh7XG4gICAgbW9kdWxlSWQ6IG1vZHVsZS5pZCxcbiAgICBzZWxlY3RvcjogXCJteS1tZXNzYWdlXCIsXG4gICAgdGVtcGxhdGVVcmw6IFwiLi9tZXNzYWdlLmNvbXBvbmVudC5odG1sXCIsXG59KVxuZXhwb3J0IGNsYXNzIE1lc3NhZ2VDb21wb25lbnQgaW1wbGVtZW50cyBPbkluaXQsIE9uRGVzdHJveSB7XG4gICAgcHJpdmF0ZSBhYmx5OiBBYmx5UmVhbHRpbWVcbiAgICBrZXkgPSBcImhMdXg3QS5oRE1yRHc6U3hIblkteW54Uk16Y0RXUFwiXG4gICAgY2hhbm5lbElkID0gXCJwZXJzaXN0ZW50OmNoYXRcIlxuICAgIG1lc3NhZ2VzUmVjZWl2ZWQgPSBuZXcgU3ViamVjdDxzdHJpbmc+KClcbiAgICBtZXNzYWdlID0gXCJcIlxuICAgIHN0YXR1cyA9IG5ldyBTdWJqZWN0PHN0cmluZz4oKVxuICAgIGNoYW5uZWxTdWJzY3JpcHRpb246IFN1YnNjcmlwdGlvbjtcbiAgICBpY29uID0gXCJcIlxuICAgIGhpc3RvcnkgPSBbXVxuICAgIGNvbnN0cnVjdG9yKHByaXZhdGUgbmdab25lOiBOZ1pvbmUpIHtcblxuICAgIH1cbiAgICBuZ09uSW5pdCgpIHtcbiAgICAgICAgdGhpcy5pY29uID0gU3RyaW5nLmZyb21DaGFyQ29kZSgweGU5NjMpXG4gICAgICAgIHRoaXMuY29ubmVjdCgpXG4gICAgfVxuICAgIG5nT25EZXN0cm95KCkge1xuICAgICAgICB0aGlzLmNoYW5uZWxTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKVxuICAgIH1cbiAgICBwdWJsaWMgY29ubmVjdCgpIHtcbiAgICAgICAgaWYgKHRoaXMuYWJseSA9PSBudWxsKSB7XG4gICAgICAgICAgICBjb25zb2xlLmluZm8oXCJDcmVhdGluZyBhIG5ldyBjb25uZWN0aW9uXCIpXG4gICAgICAgICAgICB0aGlzLmFibHkgPSBuZXcgQWJseVJlYWx0aW1lKHRoaXMua2V5KVxuICAgICAgICB9XG5cbiAgICAgICAgdGhpcy5jaGFubmVsU3Vic2NyaXB0aW9uID0gdGhpcy5zdWJzY3JpYmUoKVxuXG4gICAgICAgIHRoaXMuYWJseS5jb25uZWN0aW9uLm9uKClcbiAgICAgICAgICAgIC5zdWJzY3JpYmUoYyA9PiB0aGlzLm5nWm9uZS5ydW4oKCkgPT4gdGhpcy5vbkNvbm5lY3Rpb25DaGFuZ2UoYykpLCB0aGlzLmhhbmRsZUVycm9yKVxuXG4gICAgfVxuXG4gICAgcHVibGljIHNlbmRNZXNzYWdlKCkge1xuICAgICAgICBsZXQgbWVzc2FnZSA9IHRoaXMubWVzc2FnZS50cmltKCkgPT0gXCJcIiA/IFwiRGVmYXVsdFwiIDogdGhpcy5tZXNzYWdlXG4gICAgICAgIGlmICh0aGlzLmFibHkpIHtcbiAgICAgICAgICAgIGxldCBvYmplY3QgPSBKU09OLnN0cmluZ2lmeSh7IG1zZzogbWVzc2FnZSwgZnJvbTogXCJDb2RlXCIgfSlcbiAgICAgICAgICAgIHRoaXMuYWJseS5jaGFubmVscy5nZXQodGhpcy5jaGFubmVsSWQpXG4gICAgICAgICAgICAgICAgLnB1Ymxpc2hEYXRhKFwiY2hhdFwiLCBvYmplY3QpXG4gICAgICAgICAgICAgICAgLmNhdGNoKHRoaXMuaGFuZGxlRXJyb3IpXG4gICAgICAgICAgICAgICAgLnN1YnNjcmliZSgpXG4gICAgICAgIH1cbiAgICAgICAgZWxzZVxuICAgICAgICAgICAgZGlhbG9nLmFsZXJ0KFwiWW91IG5lZWQgdG8gY29ubmVjdCBmaXJzdFwiKVxuICAgIH1cblxuICAgIHB1YmxpYyBvbk1lc3NhZ2UobWVzc2FnZTogYW55KSB7XG4gICAgICAgIGxldCBqc29uID0gbWVzc2FnZVxuICAgICAgICB0aGlzLm1lc3NhZ2VzUmVjZWl2ZWQubmV4dChqc29uLmZyb20gKyBcIjogXCIgKyBqc29uLm1zZylcbiAgICB9XG5cbiAgICBwdWJsaWMgb25Db25uZWN0aW9uQ2hhbmdlKGNoYW5nZTogQ29ubmVjdGlvblN0YXRlQ2hhbmdlKSB7XG4gICAgICAgIHRoaXMuc3RhdHVzLm5leHQoY2hhbmdlLmN1cnJlbnQpXG5cbiAgICAgICAgY29uc29sZS5pbmZvKFwiQ29ubmVjdGlvbiBDaGFuZ2UgU3RhdGVcIilcbiAgICAgICAgaWYgKGNoYW5nZS5jdXJyZW50ID09IFwiY29ubmVjdGluZ1wiKSB7XG5cbiAgICAgICAgICAgIGNvbnNvbGUuaW5mbyhcIldlIGFyZSBjb25uZWN0aW5nIHRvIHRoZSBzZXJ2ZXJcIilcbiAgICAgICAgfVxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgY29uc29sZS5sb2coY2hhbmdlLmN1cnJlbnQpXG4gICAgICAgICAgICBjb25zb2xlLmxvZyhjaGFuZ2UucmVhc29uKVxuICAgICAgICB9IGNhdGNoIChleCkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihleClcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBkaXNjb25uZWN0KCkge1xuICAgICAgICB0aGlzLnN0YXR1cy5uZXh0KFwiRGlzY29ubmVjdGluZ1wiKVxuICAgICAgICBpZiAodGhpcy5hYmx5KSB7XG4gICAgICAgICAgICBjb25zb2xlLmluZm8odGhpcy5hYmx5LmNvbm5lY3Rpb24ua2V5KVxuICAgICAgICAgICAgdGhpcy5hYmx5LmNvbm5lY3Rpb24uY2xvc2UoKVxuICAgICAgICAgICAgdGhpcy5hYmx5ID0gbnVsbDtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHVuc3Vic2NyaWJlKCkge1xuICAgICAgICBpZiAodGhpcy5jaGFubmVsU3Vic2NyaXB0aW9uKSB7XG4gICAgICAgICAgICB0aGlzLmNoYW5uZWxTdWJzY3JpcHRpb24udW5zdWJzY3JpYmUoKVxuICAgICAgICB9XG4gICAgfVxuICAgIHN1YnNjcmliZSgpIHtcbiAgICAgICAgaWYgKHRoaXMuYWJseSkge1xuICAgICAgICAgICAgbGV0IGNoYW5uZWwgPSB0aGlzLmFibHkuY2hhbm5lbHMuZ2V0KHRoaXMuY2hhbm5lbElkKVxuICAgICAgICAgICAgcmV0dXJuIGNoYW5uZWwuc3Vic2NyaWJlKClcbiAgICAgICAgICAgICAgICAubWFwKG0gPT4gbS5kYXRhKVxuICAgICAgICAgICAgICAgIC5tYXAobSA9PiBKU09OLnBhcnNlKG0pKVxuICAgICAgICAgICAgICAgIC5kbygobSkgPT4gY29uc29sZS5sb2cobSkpXG4gICAgICAgICAgICAgICAgLmNhdGNoKHRoaXMuaGFuZGxlRXJyb3IpIC8vIElmIHRoZSBjb25uZWN0aW9uIHRocm93cyBhbnkgZXJyb3JcbiAgICAgICAgICAgICAgICAuc3Vic2NyaWJlKG0gPT4gdGhpcy5uZ1pvbmUucnVuKCgpID0+IHRoaXMub25NZXNzYWdlKG0pKSlcblxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmV0dXJuIG51bGw7XG4gICAgICAgIH1cbiAgICB9XG5cbiAgICBnZXRIaXN0b3J5KCkge1xuICAgICAgICBjb25zb2xlLmluZm8oXCJHZXR0aW5nIGhpc3RvcnlcIilcblxuICAgICAgICB0cnkge1xuICAgICAgICAgICAgbGV0IHBhcmFtID0gbmV3IFBhcmFtKFwidW50aWxBdHRhY2hcIiwgXCJ0cnVlXCIpXG5cbiAgICAgICAgICAgIGxldCBwYXJhbXMgPSBbcGFyYW1dXG4gICAgICAgICAgICB0aGlzLm5nWm9uZS5ydW5PdXRzaWRlQW5ndWxhcigoKSA9PiB7XG4gICAgICAgICAgICAgICAgaWYgKHRoaXMuYWJseSkge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLmFibHkuY2hhbm5lbHMuZ2V0KHRoaXMuY2hhbm5lbElkKS5oaXN0b3J5KHBhcmFtcykudGhlbihfID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuaGlzdG9yeSA9IF9cbiAgICAgICAgICAgICAgICAgICAgICAgIGRpYWxvZy5hbGVydChKU09OLnN0cmluZ2lmeShfKSlcbiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goXyA9PiBkaWFsb2cuYWxlcnQoXykpXG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfSlcblxuICAgICAgICB9Y2F0Y2goZSkge1xuICAgICAgICAgICAgY29uc29sZS5lcnJvcihlKVxuICAgICAgICB9XG4gICAgICAgIFxuICAgIH1cblxuICAgIGhhbmRsZUVycm9yKGUpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcIkEgZXJyb3IgaGFzIGNhdGNoIGJ5IG9ic2VydmVyOiBcIilcbiAgICAgICAgY29uc29sZS5lcnJvcihlKVxuICAgICAgICBkaWFsb2cuYWxlcnQoZS5tZXNzYWdlKVxuICAgICAgICByZXR1cm4gT2JzZXJ2YWJsZS5lbXB0eSgpXG4gICAgfVxufVxuIl19